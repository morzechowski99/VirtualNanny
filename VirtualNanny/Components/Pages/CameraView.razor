@page "/camera"

<MudContainer Class="pa-4">
    <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true">
        📹 Monitor dziecka
    </MudText>
    
    @if (!_isPermissionGranted)
    {
        <MudPaper Class="pa-6 ma-4" Elevation="2">
            <div style="text-align: center;">
                <MudIcon Icon="@Icons.Material.Filled.Videocam" Size="Size.Large" Color="Color.Warning" Class="mb-4" />
                <MudText Typo="Typo.h6" GutterBottom="true">Dostęp do kamery</MudText>
                <MudText Typo="Typo.body1" Class="mb-4">
                    Aplikacja potrzebuje dostępu do kamery, aby monitorować dziecko.
                </MudText>
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Primary" 
                           StartIcon="@Icons.Material.Filled.VideoCall"
                           OnClick="RequestCameraPermission"
                           Size="Size.Large">
                    Przyznaj dostęp do kamery
                </MudButton>
            </div>
        </MudPaper>
    }
    else
    {
        <!-- Video element - always present when permissions are granted -->
        <MudPaper Class="pa-4" Elevation="3">
            <div style="position: relative; text-align: center; background-color: #000; border-radius: 8px;">
                <video id="cameraVideo" 
                       autoplay 
                       playsinline 
                       muted 
                       style="width: 100%; max-width: 640px; border-radius: 8px; background-color: #000;">
                    Twoja przeglądarka nie obsługuje elementu video.
                </video>
                
                @if (_isRecording)
                {
                    <div style="position: absolute; top: 16px; right: 16px; background-color: #f44336; color: white; padding: 8px 12px; border-radius: 4px; font-size: 12px; font-weight: bold; z-index: 10;">
                        🔴 NAGRYWANIE
                    </div>
                }
                
                <!-- Loading overlay for camera initialization/switching -->
                @if (!_isCameraInitialized || _isSwitchingCamera)
                {
                    <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; border-radius: 8px; z-index: 5;">
                        <div style="text-align: center; color: white;">
                            <MudProgressCircular Color="Color.Primary" Size="Size.Large" Indeterminate="true" Class="mb-4" />
                            <MudText Typo="Typo.h6" Color="Color.Inherit">
                                @(_isSwitchingCamera ? "Przełączanie kamery..." : "Inicjalizacja kamery...")
                            </MudText>
                            <MudText Typo="Typo.body2" Color="Color.Inherit" Class="mb-4">
                                @(_isSwitchingCamera ? "Przełączanie na " + (_useFrontCamera ? "przednią" : "tylną") + " kamerę..." : "Proszę czekać, trwa łączenie z kamerą urządzenia.")
                            </MudText>
                            @if (!_isSwitchingCamera)
                            {
                                <MudButton Variant="Variant.Text" 
                                           Color="Color.Primary" 
                                           StartIcon="@Icons.Material.Filled.Refresh"
                                           OnClick="RetryInitialization"
                                           Class="mt-2">
                                    Spróbuj ponownie
                                </MudButton>
                            }
                        </div>
                    </div>
                }
            </div>
            
            <MudStack Row="true" Justify="Justify.Center" Spacing="3" Class="mt-4" Wrap="Wrap.Wrap">
                <MudButton Variant="Variant.Filled" 
                           Color="@(_isRecording ? Color.Error : Color.Success)" 
                           StartIcon="@(_isRecording ? Icons.Material.Filled.Stop : Icons.Material.Filled.FiberManualRecord)"
                           OnClick="ToggleRecording"
                           Size="Size.Large"
                           Disabled="!_isCameraInitialized || _isSwitchingCamera">
                    @(_isRecording ? "Zatrzymaj nagrywanie" : "Rozpocznij nagrywanie")
                </MudButton>
                
                <MudButton Variant="Variant.Outlined" 
                           Color="Color.Primary" 
                           StartIcon="@Icons.Material.Filled.FlipCameraAndroid"
                           OnClick="SwitchCamera"
                           Size="Size.Large"
                           Disabled="!_isCameraInitialized || _isRecording || _isSwitchingCamera">
                    @(_isSwitchingCamera ? "Przełączanie..." : "Przełącz kamerę")
                </MudButton>
                
                <MudButton Variant="Variant.Text" 
                           Color="Color.Info" 
                           StartIcon="@Icons.Material.Filled.Refresh"
                           OnClick="RetryInitialization"
                           Size="Size.Large"
                           Disabled="_isSwitchingCamera">
                    Odśwież
                </MudButton>
            </MudStack>
        </MudPaper>
        
        <!-- Camera Settings -->
        <MudPaper Class="pa-4 mt-4" Elevation="1">
            <MudText Typo="Typo.h6" GutterBottom="true">Ustawienia kamery</MudText>
            <MudStack Spacing="3">
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudText>Kamera przednia</MudText>
                    <MudSwitch Value="_useFrontCamera"
                               ValueChanged="@((bool value) => OnSwitchValueChanged(value))"
                               Color="Color.Primary" 
                               Disabled="!_isCameraInitialized || _isRecording || _isSwitchingCamera" />
                </MudStack>
                
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudText>Tryb nocny</MudText>
                    <MudSwitch Value="false" Color="Color.Secondary" Disabled="true" />
                </MudStack>
                
                <MudStack Row="true" Justify="Justify.SpaceBetween" AlignItems="AlignItems.Center">
                    <MudText>Detekcja ruchu</MudText>
                    <MudSwitch Value="false" Color="Color.Info" Disabled="true" />
                </MudStack>
            </MudStack>
        </MudPaper>
        
        <!-- Debug Information - zawsze widoczne w DEBUG -->
        @if (true) // Zawsze pokazuj w celach debugowania
        {
            <MudPaper Class="pa-4 mt-4" Elevation="1">
                <MudText Typo="Typo.h6" GutterBottom="true">Debug Info</MudText>
                <MudText Typo="Typo.body2">Permission: @_isPermissionGranted</MudText>
                <MudText Typo="Typo.body2">Initialized: @_isCameraInitialized</MudText>
                <MudText Typo="Typo.body2">Recording: @_isRecording</MudText>
                <MudText Typo="Typo.body2">Front Camera: @_useFrontCamera</MudText>
                <MudText Typo="Typo.body2">Switching: @_isSwitchingCamera</MudText>
                
                <MudButton Variant="Variant.Text" 
                           Color="Color.Info" 
                           StartIcon="@Icons.Material.Filled.BugReport"
                           OnClick="ShowJavaScriptAlert"
                           Size="Size.Small"
                           Class="mt-2">
                    Test JS Alert
                </MudButton>
                
                <MudButton Variant="Variant.Text" 
                           Color="Color.Warning" 
                           StartIcon="@Icons.Material.Filled.Info"
                           OnClick="ShowDebugStatus"
                           Size="Size.Small"
                           Class="mt-2">
                    Show Status
                </MudButton>
                
                <MudButton Variant="Variant.Text" 
                           Color="Color.Success" 
                           StartIcon="@Icons.Material.Filled.Security"
                           OnClick="ForcePermissionRequest"
                           Size="Size.Small"
                           Class="mt-2">
                    Force Permissions
                </MudButton>
                
                <MudButton Variant="Variant.Text" 
                           Color="Color.Primary" 
                           StartIcon="@Icons.Material.Filled.Science"
                           OnClick="TestAllPermissions"
                           Size="Size.Small"
                           Class="mt-2">
                    Test All Methods
                </MudButton>
                
                <MudButton Variant="Variant.Text" 
                           Color="Color.Warning" 
                           StartIcon="@Icons.Material.Filled.TouchApp"
                           OnClick="TriggerWebViewDialog"
                           Size="Size.Small"
                           Class="mt-2">
                    Trigger WebView Dialog
                </MudButton>
                
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Error" 
                           StartIcon="@Icons.Material.Filled.AdminPanelSettings"
                           OnClick="UltimatePermissionFix"
                           Size="Size.Small"
                           Class="mt-2">
                    ULTIMATE FIX
                </MudButton>
                
                <MudButton Variant="Variant.Outlined" 
                           Color="Color.Info" 
                           StartIcon="@Icons.Material.Filled.Videocam"
                           OnClick="ShowAvailableCameras"
                           Size="Size.Small"
                           Class="mt-2">
                    Show Cameras
                </MudButton>
                
                <MudButton Variant="Variant.Outlined" 
                           Color="Color.Secondary" 
                           StartIcon="@Icons.Material.Filled.VideoLibrary"
                           OnClick="CheckRecordingSupport"
                           Size="Size.Small"
                           Class="mt-2">
                    Check Recording Support
                </MudButton>
                
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Secondary" 
                           StartIcon="@Icons.Material.Filled.PlayCircle"
                           OnClick="TestRecording"
                           Size="Size.Small"
                           Class="mt-2">
                    Test Recording (5s)
                </MudButton>
                
                <MudButton Variant="Variant.Text" 
                           Color="Color.Primary" 
                           StartIcon="@Icons.Material.Filled.Download"
                           OnClick="CheckDownloadCapabilities"
                           Size="Size.Small"
                           Class="mt-2">
                    Check Download Support
                </MudButton>
                
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Warning" 
                           StartIcon="@Icons.Material.Filled.Security"
                           OnClick="EnhancedPermissionRequest"
                           Size="Size.Small"
                           Class="mt-2">
                    Enhanced Permission Request
                </MudButton>
                
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Error" 
                           StartIcon="@Icons.Material.Filled.Lock"
                           OnClick="ForceWebViewPermissions"
                           Size="Size.Small"
                           Class="mt-2">
                    Force WebView Permissions
                </MudButton>
                
                <MudButton Variant="Variant.Filled" 
                           Color="Color.Tertiary" 
                           StartIcon="@Icons.Material.Filled.CheckCircle"
                           OnClick="VerifyCameraStream"
                           Size="Size.Small"
                           Class="mt-2">
                    Verify Camera Stream
                </MudButton>
            </MudPaper>
        }
    }
</MudContainer>